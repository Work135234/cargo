<!DOCTYPE html>
<html>

<head>
    <title>Web Push Test</title>
</head>

<body>
    <h1>Web Push Notification Test</h1>
    <button id="subscribe">Subscribe to Notifications</button>
    <button id="send">Send Test Notification</button>
    <pre id="log"></pre>

    <script>
        const log = (msg) => {
            document.getElementById('log').textContent += msg + '\n';
        };

        async function registerServiceWorker() {
            try {
                const registration = await navigator.serviceWorker.register('/service-worker.js');
                log('Service Worker registered successfully');
                return registration;
            } catch (error) {
                log('Service Worker registration failed: ' + error);
                throw error;
            }
        }

        async function subscribeToNotifications() {
            try {
                const registration = await registerServiceWorker();

                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    throw new Error('Permission not granted for notifications');
                }

                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: 'BDUXfWAVARp-uMoVKlAlxzyXyGumZTFR9UjSoMa5FMJNLvzJJZMM6VOrObkEYSXPaf1t8zKvSHrk2cNdqKwPlzY'
                });

                log('Successfully subscribed to push notifications');

                // Send subscription to server
                const response = await fetch('/api/notifications/push-subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify(subscription)
                });

                if (!response.ok) {
                    throw new Error('Failed to send subscription to server');
                }

                log('Subscription sent to server successfully');
            } catch (error) {
                log('Error: ' + error.message);
            }
        }

        async function sendTestNotification() {
            try {
                const response = await fetch('/api/notifications/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to send test notification');
                }

                log('Test notification sent successfully');
            } catch (error) {
                log('Error: ' + error.message);
            }
        }

        document.getElementById('subscribe').addEventListener('click', subscribeToNotifications);
        document.getElementById('send').addEventListener('click', sendTestNotification);
    </script>
</body>

</html>